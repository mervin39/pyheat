# Implementation Plan: Replace formatted_status with formatted_next_schedule

## Overview
Replace the current `formatted_status` attribute (used for display only) with `formatted_next_schedule`, which shows ONLY future schedule information when in auto mode without override. Simplify status text for other modes and rewrite the schedule finding logic to be more robust.

## Current State Analysis

### formatted_status Usage
- **pyheat**: Generated in `status_publisher.py::_format_status_text()`
- **pyheat-web**: Displayed in `room-card.tsx` (line 92-97) for status area
- **Confirmed**: Only used for display, not for any logic or decisions

### Current Status Format Examples
- `"Auto (passive): 16-19°, 30% until 06:30 on Friday (18.0°)"`
- `"Override: 21.0° (+2.0°) until 14:30"`
- `"Manual: 20.0°"`
- `"Passive: 15-20°, 50%"`
- `"Heating Off"`

## New Requirements

### New Status Format by Mode

| Mode | Condition | Status Text |
|------|-----------|-------------|
| **off** | Always | `"Heating Off"` |
| **manual** | Always | `"Manual"` |
| **passive** | Always | `"Passive"` |
| **auto** | With override | Keep current behavior (show countdown timer) |
| **auto** | No override, forever | `"Forever"` |
| **auto** | No override, next active | `"until HH:MM [D]: S°"` |
| **auto** | No override, next passive | `"until HH:MM [D]: [V%] L-U° (passive)"` |

Where:
- `HH:MM` = time of next schedule change
- `D` = day suffix (omit if today, "tomorrow" if tomorrow, "on Monday" etc if later)
- `S` = setpoint for active mode
- `V` = valve percent for passive mode
- `L` = lower temp (min) for passive mode
- `U` = upper temp (max) for passive mode

### New Schedule Finding Logic

The current `get_next_schedule_change()` has issues. We need to rewrite it to:

1. Check current time
2. Determine if we're in a schedule block or in default mode
3. If in block:
   - Find the end time of current block
   - Check if new block is defined at end time
     - Yes: Use that block's details
     - No: Use default target details
   - Edge case: Block ends at 23:59 → look to next day 00:00
4. If in default mode:
   - Find next schedule block (may be on another day)
   - Loop through week if necessary
   - If no blocks found after full week loop → forever

## Implementation Steps

### Phase 1: Pyheat Changes

#### 1.1 Create New Method: `_get_next_schedule_info()`
Location: `services/status_publisher.py`

```python
def _get_next_schedule_info(self, room_id: str, now: datetime, holiday_mode: bool) -> Optional[Dict]:
    """Get next schedule change information.

    Returns:
        Dict with:
            'time': str (HH:MM)
            'day_offset': int (0=today, 1=tomorrow, etc)
            'mode': str ('active' or 'passive')
            'target': float (setpoint for active, min for passive)
            'passive_max_temp': float (for passive only)
            'valve_percent': int (for passive only)
        Or None if forever/no schedule
    """
```

This method will implement the new logic described in the requirements.

#### 1.2 Update `_format_status_text()` → `_format_next_schedule_text()`
- Rename method
- Simplify logic:
  - Off → "Heating Off"
  - Manual → "Manual"
  - Passive → "Passive"
  - Auto with override → Keep current (unchanged)
  - Auto without override → Use `_get_next_schedule_info()` to build status

#### 1.3 Update `publish_room_entities()`
- Change attribute name from `formatted_status` to `formatted_next_schedule`
- Call renamed method

#### 1.4 Update `api_handler.py`
- Update `_strip_time_from_status()` to handle new format
- Update `api_get_status()` to use `formatted_next_schedule`

#### 1.5 Testing
- Check logs for errors
- Verify status text displays correctly for all modes
- Test edge cases:
  - Block ending at 23:59
  - No blocks (forever)
  - Gaps between blocks
  - Multiple days ahead

### Phase 2: Pyheat-Web Changes

#### 2.1 Update Type Definitions
Location: `client/src/types/api.ts`

```typescript
export interface RoomStatus {
  // ... existing fields ...
  formatted_next_schedule?: string; // Renamed from formatted_status
  // Remove formatted_status
}
```

#### 2.2 Update room-card.tsx
- Line 92: Change `room.formatted_status` to `room.formatted_next_schedule`
- Update comments to reflect new purpose

#### 2.3 Update Other Files
Search and replace `formatted_status` with `formatted_next_schedule` in:
- `client/src/components/embed-room-card.tsx`
- `client/src/components/room-control-panel.tsx`
- `server/models.py`
- `server/ha_client.py`
- `server/main.py`

#### 2.4 Rebuild and Test
```bash
cd /opt/appdata/pyheat-web
docker compose up -d --build
```

- Verify all room cards display correctly
- Test all modes (auto, manual, passive, off)
- Test override behavior
- Test edge cases

### Phase 3: Documentation

#### 3.1 Update pyheat/docs/changelog.md
Document the change:
- What changed
- Why (status line now focuses on future schedule info only)
- How it affects the display

#### 3.2 Update pyheat-web/docs/changelog.md
Document the web UI changes:
- Renamed field
- Updated display logic

#### 3.3 Update ARCHITECTURE.md (if needed)
Only if the architectural pattern changed significantly.

### Phase 4: Commit

```bash
cd /opt/appdata/appdaemon/conf/apps/pyheat
git add -A
git commit -m "Replace formatted_status with formatted_next_schedule

- Rename formatted_status to formatted_next_schedule
- Simplify status text for non-auto modes (Off, Manual, Passive)
- Rewrite schedule finding logic to be more robust
- Fix edge cases in schedule detection (block ending at 23:59, gaps, forever)
- Auto mode with override keeps existing behavior
- Auto mode without override shows next schedule change details

Affects: status_publisher.py, api_handler.py, scheduler.py"

cd /opt/appdata/pyheat-web
git add -A
git commit -m "Update to use formatted_next_schedule instead of formatted_status

- Rename field in TypeScript types
- Update components to use new field name
- Rebuild and deploy

Follows pyheat changes to simplify status line display"
```

## Key Decisions & Edge Cases

### Edge Case: Block Ending at 23:59
When a block ends at 23:59, we need to look at 00:00 of the next day to determine the next state.

### Edge Case: Forever Schedule
If after looping through entire week no blocks are found, display "Forever".

### Edge Case: Same Temperature
Only report a "change" if the temperature actually changes. Skip blocks with same temperature.

### Override Behavior
Keep existing override display logic unchanged - it works well.

## Validation Checklist

Before completing:
- [ ] All pyheat files modified
- [ ] No errors in AppDaemon logs
- [ ] Status text displays correctly for all modes
- [ ] Edge cases tested (forever, 23:59 end time, gaps)
- [ ] pyheat-web files updated
- [ ] pyheat-web rebuilt and deployed
- [ ] Web UI displays correctly
- [ ] Documentation updated
- [ ] Both repos committed (not pushed)

## Risks & Mitigation

**Risk**: Breaking change in API could cause pyheat-web to display incorrectly
**Mitigation**: Update both codebases in same session, test thoroughly before committing

**Risk**: New schedule logic has bugs
**Mitigation**: Carefully implement with extensive logging, test all edge cases

**Risk**: Missing some file that references formatted_status
**Mitigation**: Use grep to find all occurrences before making changes
