# PyHeat package for Home Assistant
# Includes the helper entities that the AppDaemon PyHeat app expects or can use.
# This package groups the same entities that previously lived as separate YAML
# fragments under ha_yaml/*.yaml into a single package file for convenience.
#
# Drop this file into your Home Assistant packages directory (and include it
# from configuration.yaml) or copy the relevant sections into your existing
# YAML structure. This file is provided for convenience and is NOT committed.

 

# ---------------------------------------------------------------------------
# Input booleans
# ---------------------------------------------------------------------------
input_boolean:
  pyheat_master_enable:
    name: "PyHeat Master Enable"
    icon: mdi:home-automation

  pyheat_holiday_mode:
    name: "PyHeat Holiday Mode"
    icon: mdi:airplane

# ---------------------------------------------------------------------------
# Input selects (load sharing mode control + per-room modes)
# ---------------------------------------------------------------------------
input_select:
  pyheat_load_sharing_mode:
    name: "Load Sharing Mode"
    options:
      - 'Off'
      - 'Conservative'
      - 'Balanced'
      - 'Aggressive'
    icon: mdi:tune-variant

  pyheat_pete_mode:
    name: Pete's Room Heating Mode
    options:
      - Auto
      - Manual
      - Passive
      - 'Off'
    icon: mdi:cogs

  pyheat_abby_mode:
    name: Abby's Room Heating Mode
    options:
      - Auto
      - Manual
      - Passive
      - 'Off'
    icon: mdi:cogs

  pyheat_bathroom_mode:
    name: Bathroom Heating Mode
    options:
      - Auto
      - Manual
      - Passive
      - 'Off'
    icon: mdi:cogs

  pyheat_games_mode:
    name: Dining Room Heating Mode
    options:
      - Auto
      - Manual
      - Passive
      - 'Off'
    icon: mdi:cogs

  pyheat_lounge_mode:
    name: Living Room Heating Mode
    options:
      - Auto
      - Manual
      - Passive
      - 'Off'
    icon: mdi:cogs

  pyheat_office_mode:
    name: Office Heating Mode
    options:
      - Auto
      - Manual
      - Passive
      - 'Off'
    icon: mdi:cogs

# ---------------------------------------------------------------------------
# Input numbers (manual setpoints and override targets)
# ---------------------------------------------------------------------------
input_number:
  # Override persistence targets
  pyheat_pete_override_target:
    name: "Pete's Room Override Target"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box

  pyheat_abby_override_target:
    name: "Abby's Room Override Target"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box

  pyheat_office_override_target:
    name: "Office Override Target"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box

  pyheat_lounge_override_target:
    name: "Living Room Override Target"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box

  pyheat_games_override_target:
    name: "Dining Room Override Target"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box

  pyheat_bathroom_override_target:
    name: "Bathroom Override Target"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box

  # Manual setpoints
  pyheat_pete_manual_setpoint:
    name: "Pete's Room Manual Setpoint"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:radiator

  pyheat_abby_manual_setpoint:
    name: "Abby's Room Manual Setpoint"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:radiator

  pyheat_office_manual_setpoint:
    name: "Office Manual Setpoint"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:radiator

  pyheat_lounge_manual_setpoint:
    name: "Living Room Manual Setpoint"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:radiator

  pyheat_games_manual_setpoint:
    name: "Dining Room Manual Setpoint"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:radiator

  pyheat_bathroom_manual_setpoint:
    name: "Bathroom Manual Setpoint"
    min: 5
    max: 35
    step: 0.1
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:radiator

  # Passive MODE settings (used when room mode selector is set to "passive")
  # Note: These are NOT used for scheduled passive blocks - those use schedule's default_valve_percent etc.
  pyheat_pete_passive_mode_max_temp:
    name: "Pete's Room Passive Mode Max Temp"
    min: 10
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-high
    initial: 18.0

  pyheat_pete_passive_mode_valve_percent:
    name: "Pete's Room Passive Mode Valve Percent"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:valve
    initial: 30

  pyheat_abby_passive_mode_max_temp:
    name: "Abby's Room Passive Mode Max Temp"
    min: 10
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-high
    initial: 18.0

  pyheat_abby_passive_mode_valve_percent:
    name: "Abby's Room Passive Mode Valve Percent"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:valve
    initial: 30

  pyheat_office_passive_mode_max_temp:
    name: "Office Passive Mode Max Temp"
    min: 10
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-high
    initial: 18.0

  pyheat_office_passive_mode_valve_percent:
    name: "Office Passive Mode Valve Percent"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:valve
    initial: 30

  pyheat_lounge_passive_mode_max_temp:
    name: "Living Room Passive Mode Max Temp"
    min: 10
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-high
    initial: 18.0

  pyheat_lounge_passive_mode_valve_percent:
    name: "Living Room Passive Mode Valve Percent"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:valve
    initial: 30

  pyheat_games_passive_mode_max_temp:
    name: "Dining Room Passive Mode Max Temp"
    min: 10
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-high
    initial: 18.0

  pyheat_games_passive_mode_valve_percent:
    name: "Dining Room Passive Mode Valve Percent"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:valve
    initial: 30

  pyheat_bathroom_passive_mode_max_temp:
    name: "Bathroom Passive Mode Max Temp"
    min: 10
    max: 30
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-high
    initial: 18.0

  pyheat_bathroom_passive_mode_valve_percent:
    name: "Bathroom Passive Mode Valve Percent"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:valve
    initial: 30

  # Passive MODE minimum temperatures (comfort floor)
  pyheat_pete_passive_mode_min_temp:
    name: "Pete's Room Passive Mode Min Temp"
    min: 8
    max: 20
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-low

  pyheat_abby_passive_mode_min_temp:
    name: "Abby's Room Passive Mode Min Temp"
    min: 8
    max: 20
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-low

  pyheat_office_passive_mode_min_temp:
    name: "Office Passive Mode Min Temp"
    min: 8
    max: 20
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-low

  pyheat_lounge_passive_mode_min_temp:
    name: "Living Room Passive Mode Min Temp"
    min: 8
    max: 20
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-low

  pyheat_games_passive_mode_min_temp:
    name: "Dining Room Passive Mode Min Temp"
    min: 8
    max: 20
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-low

  pyheat_bathroom_passive_mode_min_temp:
    name: "Bathroom Passive Mode Min Temp"
    min: 8
    max: 20
    step: 0.5
    unit_of_measurement: "°C"
    mode: box
    icon: mdi:thermometer-low

  # OpenTherm flow temperature setpoint (for cycling protection)
  pyheat_opentherm_setpoint:
    name: "PyHeat OpenTherm Flow Temperature Setpoint"
    min: 30
    max: 80
    step: 1
    unit_of_measurement: "°C"
    mode: slider
    initial: 70
    icon: mdi:thermometer

# ---------------------------------------------------------------------------
# Timers (per-room override timers + boiler safety timers)
# ---------------------------------------------------------------------------
timer:
  pyheat_pete_override:
    name: "Pete's Room Override Timer"
    restore: true
    duration: "00:00:00"
    icon: mdi:timer

  pyheat_abby_override:
    name: "Abby's Room Override Timer"
    restore: true
    duration: "00:00:00"
    icon: mdi:timer

  pyheat_office_override:
    name: "Office Override Timer"
    restore: true
    duration: "00:00:00"
    icon: mdi:timer

  pyheat_lounge_override:
    name: "Living Room Override Timer"
    restore: true
    duration: "00:00:00"
    icon: mdi:timer

  pyheat_games_override:
    name: "Dining Room Override Timer"
    restore: true
    duration: "00:00:00"
    icon: mdi:timer

  pyheat_bathroom_override:
    name: "Bathroom Override Timer"
    restore: true
    duration: "00:00:00"
    icon: mdi:timer

  pyheat_boiler_min_on_timer:
    name: "Boiler Minimum On Timer"
    restore: false
    duration: "00:00:00"
    icon: mdi:timer-check

  pyheat_boiler_min_off_timer:
    name: "Boiler Minimum Off Timer"
    restore: false
    duration: "00:00:00"
    icon: mdi:timer-check

  pyheat_boiler_off_delay_timer:
    name: "Boiler Off Delay Timer"
    restore: false
    duration: "00:00:00"
    icon: mdi:timer-sand

  pyheat_boiler_pump_overrun_timer:
    name: "Boiler Pump Overrun Timer"
    restore: false
    duration: "00:00:00"
    icon: mdi:pump

# ---------------------------------------------------------------------------
# Input text - DEPRECATED: Persistence migrated to local file
# ---------------------------------------------------------------------------
# The following entities are no longer used by PyHeat as of the persistence
# migration. State is now persisted to /opt/appdata/appdaemon/conf/apps/pyheat/state/persistence.json
# These entities can be safely removed from your configuration after confirming
# PyHeat is working correctly with file-based persistence.
#
# input_text:
#   pyheat_room_persistence:
#     name: "PyHeat Room State Persistence (DEPRECATED)"
#     initial: ""
#     max: 255
#
#   pyheat_pump_overrun_valves:
#     name: "PyHeat Pump Overrun Valve Positions (DEPRECATED)"
#     initial: ""
#     max: 255
#
#   pyheat_cycling_protection_state:
#     name: "PyHeat Cycling Protection State (DEPRECATED)"
#     initial: '{"mode":"NORMAL","saved_setpoint":null,"cooldown_start":null}'
#     max: 255

# ---------------------------------------------------------------------------
# MQTT sensors (TRV feedback) - these are important for valve feedback
# The state_topic values below match the Zigbee2MQTT topics used in the
# original ha_yaml. Adjust topics if your TRV integration differs.
# These are declared under the `mqtt:` domain in legacy YAML form because
# some Home Assistant setups disallow `platform: mqtt` under `sensor:`.
# ---------------------------------------------------------------------------
mqtt:
  sensor:
    - name: "TRV Pete Valve Closing Degree (Z2M)"
      unique_id: trv_pete_valve_closing_degree_z2m
      state_topic: "zigbee2mqtt/trv_pete"
      value_template: "{{ value_json.valve_closing_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_pete/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Pete Valve Opening Degree (Z2M)"
      unique_id: trv_pete_valve_opening_degree_z2m
      state_topic: "zigbee2mqtt/trv_pete"
      value_template: "{{ value_json.valve_opening_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_pete/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Lounge Valve Closing Degree (Z2M)"
      unique_id: trv_lounge_valve_closing_degree_z2m
      state_topic: "zigbee2mqtt/trv_lounge"
      value_template: "{{ value_json.valve_closing_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_lounge/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Lounge Valve Opening Degree (Z2M)"
      unique_id: trv_lounge_valve_opening_degree_z2m
      state_topic: "zigbee2mqtt/trv_lounge"
      value_template: "{{ value_json.valve_opening_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_lounge/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Games Valve Closing Degree (Z2M)"
      unique_id: trv_games_valve_closing_degree_z2m
      state_topic: "zigbee2mqtt/trv_games"
      value_template: "{{ value_json.valve_closing_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_games/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Games Valve Opening Degree (Z2M)"
      unique_id: trv_games_valve_opening_degree_z2m
      state_topic: "zigbee2mqtt/trv_games"
      value_template: "{{ value_json.valve_opening_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_games/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Abby Valve Closing Degree (Z2M)"
      unique_id: trv_abby_valve_closing_degree_z2m
      state_topic: "zigbee2mqtt/trv_abby"
      value_template: "{{ value_json.valve_closing_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_abby/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Abby Valve Opening Degree (Z2M)"
      unique_id: trv_abby_valve_opening_degree_z2m
      state_topic: "zigbee2mqtt/trv_abby"
      value_template: "{{ value_json.valve_opening_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_abby/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Office Valve Closing Degree (Z2M)"
      unique_id: trv_office_valve_closing_degree_z2m
      state_topic: "zigbee2mqtt/trv_office"
      value_template: "{{ value_json.valve_closing_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_office/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Office Valve Opening Degree (Z2M)"
      unique_id: trv_office_valve_opening_degree_z2m
      state_topic: "zigbee2mqtt/trv_office"
      value_template: "{{ value_json.valve_opening_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_office/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Bathroom Valve Closing Degree (Z2M)"
      unique_id: trv_bathroom_valve_closing_degree_z2m
      state_topic: "zigbee2mqtt/trv_bathroom"
      value_template: "{{ value_json.valve_closing_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_bathroom/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

    - name: "TRV Bathroom Valve Opening Degree (Z2M)"
      unique_id: trv_bathroom_valve_opening_degree_z2m
      state_topic: "zigbee2mqtt/trv_bathroom"
      value_template: "{{ value_json.valve_opening_degree | int }}"
      unit_of_measurement: "%"
      state_class: measurement
      availability_topic: "zigbee2mqtt/trv_bathroom/availability"
      availability_template: "{{ value_json.state }}"
      payload_available: "online"
      payload_not_available: "offline"

# ---------------------------------------------------------------------------
# REST Commands - Direct API access to AppDaemon services
# These are called by the script wrappers below
# Adjust the localhost:5050 URL if your AppDaemon is on a different host/port
# ---------------------------------------------------------------------------
rest_command:
  pyheat_api_override:
    url: "http://localhost:5050/api/appdaemon/pyheat_override"
    method: POST
    content_type: "application/json"
    payload: "{{ payload }}"

  pyheat_api_cancel_override:
    url: "http://localhost:5050/api/appdaemon/pyheat_cancel_override"
    method: POST
    content_type: "application/json"
    payload: "{{ payload }}"

  pyheat_api_set_mode:
    url: "http://localhost:5050/api/appdaemon/pyheat_set_mode"
    method: POST
    content_type: "application/json"
    payload: "{{ payload }}"

  pyheat_api_reload_config:
    url: "http://localhost:5050/api/appdaemon/pyheat_reload_config"
    method: POST
    content_type: "application/json"
    payload: "{}"

# ---------------------------------------------------------------------------
# Script Wrappers - User-friendly services with field validation
# These provide a clean interface to call PyHeat services from HA
# ---------------------------------------------------------------------------
script:
  pyheat_override:
    alias: "PyHeat: Temperature Override"
    description: "Set a temporary temperature override for a room"
    fields:
      room:
        description: "Room ID"
        example: "pete"
        required: true
        selector:
          select:
            options:
              - pete
              - abby
              - office
              - lounge
              - games
              - bathroom
      target:
        description: "Target temperature in °C (use either target OR delta, not both)"
        example: 21.0
        selector:
          number:
            min: 10
            max: 35
            step: 0.5
            unit_of_measurement: "°C"
      delta:
        description: "Temperature adjustment from schedule (e.g., +2.0 or -1.5)"
        example: 2.0
        selector:
          number:
            min: -10
            max: 10
            step: 0.5
            unit_of_measurement: "°C"
      minutes:
        description: "Duration in minutes (use either minutes OR end_time, not both)"
        example: 120
        selector:
          number:
            min: 1
            max: 1440
            unit_of_measurement: "min"
      end_time:
        description: "End time in ISO format (e.g., 2025-11-11T22:30:00)"
        example: "2025-11-11T22:30:00"
        selector:
          text:
    sequence:
      - service: rest_command.pyheat_api_override
        data:
          payload: >
            {
              "room": "{{ room }}",
              {% if target is defined %}"target": {{ target }},{% endif %}
              {% if delta is defined %}"delta": {{ delta }},{% endif %}
              {% if minutes is defined %}"minutes": {{ minutes }},{% endif %}
              {% if end_time is defined %}"end_time": "{{ end_time }}",{% endif %}
              "_dummy": null
            }

  pyheat_cancel_override:
    alias: "PyHeat: Cancel Override"
    description: "Cancel an active temperature override for a room"
    fields:
      room:
        description: "Room ID"
        example: "pete"
        required: true
        selector:
          select:
            options:
              - pete
              - abby
              - office
              - lounge
              - games
              - bathroom
    sequence:
      - service: rest_command.pyheat_api_cancel_override
        data:
          payload: '{"room": "{{ room }}"}'

  pyheat_set_mode:
    alias: "PyHeat: Set Room Mode"
    description: "Change heating mode for a room (Auto/Manual/Off)"
    fields:
      room:
        description: "Room ID"
        example: "pete"
        required: true
        selector:
          select:
            options:
              - pete
              - abby
              - office
              - lounge
              - games
              - bathroom
      mode:
        description: "Heating mode"
        required: true
        selector:
          select:
            options:
              - auto
              - manual
              - passive
              - "off"
      manual_setpoint:
        description: "Manual temperature setpoint (only used when mode is 'manual')"
        example: 20.5
        selector:
          number:
            min: 10
            max: 35
            step: 0.5
            unit_of_measurement: "°C"
    sequence:
      - service: rest_command.pyheat_api_set_mode
        data:
          payload: >
            {
              "room": "{{ room }}",
              "mode": "{{ mode }}"
              {% if manual_setpoint is defined %},"manual_setpoint": {{ manual_setpoint }}{% endif %}
            }

  pyheat_reload_config:
    alias: "PyHeat: Reload Configuration"
    description: "Reload PyHeat configuration files (rooms.yaml, schedules.yaml, boiler.yaml)"
    sequence:
      - service: rest_command.pyheat_api_reload_config
        data: {}


